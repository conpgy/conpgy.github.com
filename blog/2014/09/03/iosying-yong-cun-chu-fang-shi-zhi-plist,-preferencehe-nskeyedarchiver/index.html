
<!DOCTYPE HTML>

<html>

<head>
	<meta charset="utf-8">
	<title>iOS应用存储方式之Plist、Preference和NSKeyedArchiver - 无着的博客</title>
	<meta name="author" content="无着">

	
	<meta name="description" content="iOS应用存储方式之Plist、Preference和NSKeyedArchiver iOS应用数据存储方式 XML属性列表（plist）归档
Preference（偏好设置）
NSkeyedArchiver归档(NSCoding)
SQLite3
Core Data 应用沙盒 &hellip;">
	

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

	<link href="/atom.xml" rel="alternate" title="无着的博客" type="application/atom+xml">
	
	<link rel="canonical" href="http://conpgy.github.io/blog/2014/09/03/iosying-yong-cun-chu-fang-shi-zhi-plist%2C-preferencehe-nskeyedarchiver/">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<link href="/stylesheets/font-awesome.min.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<link href='http://fonts.googleapis.com/css?family=Nunito:400,300,700' rel='stylesheet' type='text/css'>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	
  

</head>


<body>
	<div class="container">
		<div class="left-col">
			<div class="intrude-less">
			<header id="header" class="inner"><div class="profilepic">
	
	<script src="/javascripts/md5.js"></script>
	<script type="text/javascript">
		$(function(){
			$('.profilepic').append("<img src='http://www.gravatar.com/avatar/" + MD5("conpgy@gmail.com") + "?s=160' alt='Profile Picture' style='width: 160px;' />");
		});
	</script>
	
</div>
<hgroup>
  <h1><a href="/">无着的博客</a></h1>
  
    <h2>一即一切，一切即一</h2>
  
</hgroup>


<nav id="main-nav"><ul class="main">
    <li><a href="/">Blog</a></li>
    <li><a href="http://about.me/uzhuo">About me</a></li>
    <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
<nav id="sub-nav">
	<div class="social">
		
			<a class="email" href="mailto:conpgy@gmail.com" title="Email">Email</a>
		
		
		
		
		
			<a class="github" href="https://github.com/conpgy" title="GitHub">GitHub</a>
		
		
		
		
		
		
		
		
		
		
    	
    	
			<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
	</div>
</nav>
</header>				
			</div>
		</div>	
		<div class="mid-col">
			
				
			
			<div class="mid-col-container">
				<div id="content" class="inner"><article class="post" itemscope itemtype="http://schema.org/BlogPosting">
	<h1 class="title" itemprop="name">iOS应用存储方式之Plist、Preference和NSKeyedArchiver</h1>
	<div class="entry-content" itemprop="articleBody"><h3>iOS应用数据存储方式</h3>

<ul>
<li><p>XML属性列表（plist）归档</p></li>
<li><p>Preference（偏好设置）</p></li>
<li><p>NSkeyedArchiver归档(NSCoding)</p></li>
<li><p>SQLite3</p></li>
<li><p>Core Data</p></li>
</ul>


<!-- more -->


<h5>应用沙盒</h5>

<p>每个iOS应用都有自己的应用沙盒(文件系统目录),与其他文件系统隔离。应用必须待在自己的沙盒里，其他应用不能访问该沙盒。</p>

<ul>
<li>Documents: 保存应用程序运行时生成的需要持久化的数据，iTunes同步设备时会备份该目录。例如，游戏应用可将游戏归档保存在该目录。</li>
<li>tmp: 保存应用运行时所需的临时数据，使用完毕后再将相应的文件从该目录删除。应用没有运行时，系统也可能会清除该目录下的文件。iTunes同步设备时不会同步该目录。</li>
<li>Library/Caches: 保存应用运行时生成的需要持久化的数据，iTunes同步设备时不会备份该目录。一般存储体积大，不需要备份的非重要数据。</li>
<li>Library/Preference: 保存应用所有的偏好设置，iOS的Settings(设置)应用会在该目录中查找应用的设置的设置信息。iTunes同步设备时会备份该目录。</li>
</ul>


<h5>应用沙盒的常见获取方式</h5>

<p>沙盒根目录：</p>

<pre><code>NSString *home = NSHomeDirectory();
</code></pre>

<p><strong>Documents:(2种方式)</strong></p>

<p>一. 利用沙盒根目录拼接&#8221;Documents&#8221;字符串</p>

<pre><code>NSString *home = NSHomeDirectory();
NSString *documents = [home stringByAppendingPathComponent:@"Documents"];
// 不建议，新版本操作系统可能会修改该目录名
</code></pre>

<p>二. 利用NSSearchPathForDirectoriesInDomain函数</p>

<pre><code>// NSUserDomainMask 代表从用户文件夹下找
// YES 代表展开路径中的波浪字符“~”
NSArray *array =  NSSearchPathForDirectoriesInDomains(NSDocumentDirectory, NSUserDomainMask, NO);
// 在iOS中，只有一个目录跟传入的参数匹配，所以这个集合里面只有一个元素
NSString *documents = [array objectAtIndex:0];
</code></pre>

<p><strong>tmp: NSString *tmp = NSTempraryDirectory()</strong></p>

<p><strong>Library/Caches:(跟Documents类似两种方法)</strong></p>

<p><strong>Library/Preference: 通过NSUserDefaults类获取该目下的设置信息</strong></p>

<h5>XML属性列表（plist）归档</h5>

<p>属性列表是一种XML格式的文件。扩展名为plist</p>

<p>如果对象是NSString、NSDictionary、NSArray、NSData、NSNumber等类型，就可以使用writeToFile:actomaiclly:方法直接将对象写到属性列表中。例如：</p>

<pre><code>// 将数据封装成字典
NSMutableDictionary *dict = [NSMutableDictionary dictionary];
[dict setObject:@"母鸡" forKey:@"name"];
[dict setObject:@"15013141314" forKey:@"phone"];
[dict setObject:@"27" forKey:@"age"];
// 将字典持久化到Documents/stu.plist文件中
[dict writeToFile:path atomically:YES];
</code></pre>

<p>读取属性列表：</p>

<pre><code>// 读取Documents/stu.plist的内容，实例化NSDictionary
NSDictionary *dict = [NSDictionary dictionaryWithContentsOfFile:path];
NSLog(@"name:%@", [dict objectForKey:@"name"]);
NSLog(@"phone:%@", [dict objectForKey:@"phone"]);
NSLog(@"age:%@", [dict objectForKey:@"age"]);
</code></pre>

<h5>Preference（偏好设置）</h5>

<ul>
<li>很多iOS应用都支持偏好设置，比如保存用户名、密码、字体大小等设置，iOS提供了一套标准的解决方案来为应用加入偏好设置功能</li>
<li>每个应用都有个NSUserDefaults实例，通过它来存取偏好设置</li>
<li>比如，保存用户名、字体大小、是否自动登录</li>
</ul>


<p>&mdash;</p>

<pre><code>NSUserDefaults *defaults = [NSUserDefaults standardUserDefaults];
[defaults setObject:@"itcast" forKey:@"username"];
[defaults setFloat:18.0f forKey:@"text_size"];
[defaults setBool:YES forKey:@"auto_login"];
</code></pre>

<ul>
<li>读取上次保存的设置</li>
</ul>


<p>&mdash;</p>

<pre><code>NSUserDefaults *defaults = [NSUserDefaults standardUserDefaults];
NSString *username = [defaults stringForKey:@"username"];
float textSize = [defaults floatForKey:@"text_size"];
BOOL autoLogin = [defaults boolForKey:@"auto_login"];
</code></pre>

<p><strong>注意</strong></p>

<p>UserDefaults设置数据时，不是立即写入，而是根据时间戳定时地把缓存中的的数据写入本地磁盘。所以调用了set方法之后数据有可能还没有写入磁盘应用程序就终止了。可以通过调用<code>synchornize</code>方法强制写入：</p>

<pre><code>[defaults synchornize];
</code></pre>

<h5>NSkeyedArchiver</h5>

<ul>
<li>如果对象是NSString、NSDictionary、NSArray、NSData、NSNumber等类型，可以直接用NSKeyedArchiver进行归档和恢复。</li>
<li>不是所有的对象都可以直接使用这种方法进行归档，只有遵守了NSCoding协议的对象才可以。</li>
</ul>


<p>NSCoding协议有两个方法:</p>

<p><strong>encodeWithCoder:</strong></p>

<p>每次归档对象时，都会调用这个方法。一般在这个方法里面指定如何归档对象中的实例变量，可以使用<code>encodeObject:forKey:</code>方法归档实例变量。</p>

<p><strong>initWithCoder</strong></p>

<p>每次从文件解码对象时，都会调用这个方法。一般在这个方法里面指定如何解码文件中的数据为对象的实例变量，可以使用<code>decodeObjectForKey:</code>方法解码实例变量。</p>

<p>示例：</p>

<pre><code>// 归档
Person *person = [[Person alloc] init];
person.name = @"Lily";
person.age = 27;
person.height = 1.83f;
[NSKeyedArchiver archiveRootObject:person toFile:path];

// 解码
Person *person = [NSKeyedUnarchiver unarchiveObjectWithFile:path];
</code></pre>

<p>对于Person.m文件:</p>

<pre><code>@implementation Person

- (void)encodeWithCoder:(NSCoder *)encoder {
    [encoder encodeObject:self.name forKey:@"name"];
    [encoder encodeInt:self.age forKey:@"age"];
    [encoder encodeFloat:self.height forKey:@"height"];
}
- (id)initWithCoder:(NSCoder *)decoder {
    self.name = [decoder decodeObjectForKey:@"name"];
    self.age = [decoder decodeIntForKey:@"age"];
    self.height = [decoder decodeFloatForKey:@"height"];
    return self;
}
@end
</code></pre>

<p><strong>NSKeyedArchiver归档对象注意:</strong></p>

<p>如果父类也遵守了NSCoding协议，应该在<code>encodeWithCoder:</code>方法加上一句<code>[super encodeWithCode:encode]</code>，确保继承的实例变量也能被编码，即也能被归档。应该在<code>initWithCoder:</code>方法加上:<code>self = [super initWithCoder:decoder]</code>确保集成的实例变量也能被解码。</p>

<h6>归档NSData</h6>

<p>使用<code>archiveRootObject:toFile:</code>方法可以将一个对象直接写入到一个文件中，但有时候可能想将多个对象写入到同一个文件中，那么就使用NSData来进行归档对象。</p>

<p>NSData可以为一些数据提供临时的存储空间，以便以后写入文件，或者存放从磁盘文件读取的内容。可以使用<code>[NSMutableData data]</code>创建可变数据空间。</p>

<p>示例：</p>

<pre><code>// 归档
// 新建一块可变数据区
NSMutableData *data = [NSMutableData data];
// 将数据区连接到一个NSKeyedArchiver对象
NSKeyedArchiver *archiver = [[[NSKeyedArchiver alloc] initForWritingWithMutableData:data] autorelease];
// 开始存档对象，存档的数据都会存储到NSMutableData中
[archiver encodeObject:person1 forKey:@"person1"];
[archiver encodeObject:person2 forKey:@"person2"];
// 存档完毕(一定要调用这个方法)
[archiver finishEncoding];
// 将存档的数据写入文件
[data writeToFile:path atomically:YES];

// 解码
// 从文件中读取数据
NSData *data = [NSData dataWithContentsOfFile:path];
// 根据数据，解析成一个NSKeyedUnarchiver对象
NSKeyedUnarchiver *unarchiver = [[NSKeyedUnarchiver alloc] initForReadingWithData:data];
Person *person1 = [unarchiver decodeObjectForKey:@"person1"];
Person *person2 = [unarchiver decodeObjectForKey:@"person2"];
// 恢复完毕
[unarchiver finishDecoding];
</code></pre>

<h5>利用归档可以实现深复制</h5>

<p>比如对一个Person对象进行深复制</p>

<pre><code>// 临时存储person1的数据
NSData *data = [NSKeyedArchiver archivedDataWithRootObject:person1];
// 解析data，生成一个新的Person对象
Student *person2 = [NSKeyedUnarchiver unarchiveObjectWithData:data];
// 分别打印内存地址
NSLog(@"person1:0x%x", person1); // person1:0x7177a60
NSLog(@"person2:0x%x", person2); // person2:0x7177cf0
</code></pre>
</div>

</article>

	<div class="share">
	<div class="addthis_toolbox addthis_default_style ">
	
	
	
	<a class="addthis_counter addthis_pill_style"></a>
	</div>
  <script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid="></script>
</div>



<section id="comment">
    <h1 class="title">Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
</section>
</div>
			</div>
			<footer id="footer" class="inner">Copyright &copy; 2014

    无着


Design credit: <a href="http://shashankmehta.in/archive/2012/greyshade.html">Shashank Mehta</a></footer>
		</div>
	</div>
	<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->


<script type="text/javascript">
      var disqus_shortname = 'uzhuo';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://conpgy.github.io/blog/2014/09/03/iosying-yong-cun-chu-fang-shi-zhi-plist%2C-preferencehe-nskeyedarchiver/';
        var disqus_url = 'http://conpgy.github.io/blog/2014/09/03/iosying-yong-cun-chu-fang-shi-zhi-plist%2C-preferencehe-nskeyedarchiver/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





</body>
</html>
